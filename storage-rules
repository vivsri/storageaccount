$VNetRGName = "az-ps-rg"
$VNetName = "az-ps-rg-vnet"
$IPAddressRange = "10.1.0.0/16"
$snet1 = "subnet1"
$snet2 = "subnet2"
$saname = "mynetworkstorageaccount"


#Get VNet Object
$VNet = Get-AzVirtualNetwork -Name $VNetName -ResourceGroupName $VNetRGName

#Add IP address range to the vnet
$VNet.AddressSpace.AddressPrefixes.Add($IPAddressRange)


$frontendSubnet = New-AzVirtualNetworkSubnetConfig -Name $snet1 -AddressPrefix "10.1.0.0/24" ## Create subnet1
$backendSubnet = New-AzVirtualNetworkSubnetConfig -Name $snet2 -AddressPrefix "10.1.1.0/24" ## Create subnet2
Add-AzVirtualNetworkSubnetConfig -Name $snet1 -VirtualNetwork $VNet -AddressPrefix "10.1.0.0/24" -ServiceEndpoint Microsoft.Storage
Add-AzVirtualNetworkSubnetConfig -Name $snet2 -VirtualNetwork $VNet -AddressPrefix "10.1.1.0/24" -ServiceEndpoint Microsoft.Storage

Apply configuration stored in $Vnet
Set-AzVirtualNetwork -VirtualNetwork $VNet


$subnet_new = Get-AzVirtualNetwork -ResourceGroupName $VNetRGName -Name $VNetName | Get-AzVirtualNetworkSubnetConfig -Name $snet1
Add-AzStorageAccountNetworkRule -ResourceGroupName $VNetRGName -Name $saname -VirtualNetworkResourceId $subnet_new.Id

$subnet_old = Get-AzVirtualNetwork -ResourceGroupName $VNetRGName -Name $VNetName | Get-AzVirtualNetworkSubnetConfig -Name "default"
Remove-AzStorageAccountNetworkRule -ResourceGroupName $VNetRGName -Name $saname -VirtualNetworkResourceId $subnet_old.Id

