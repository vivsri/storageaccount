$VNetRGName = "az-ps-rg"
$VNetName = "az-ps-rg-vnet"
$IPAddressRange = "10.1.0.0/16"
$subnets = @(
[pscustomobject]  @{name='subnet1';range="10.1.0.0/24"}
[pscustomobject]  @{name='subnet2';range="10.1.1.0/24"}
[pscustomobject]  @{name='subnet3';range="10.1.2.0/24"}
[pscustomobject]  @{name='subnet4';range="10.1.3.0/24"}
[pscustomobject]  @{name='subnet5';range="10.1.4.0/24"}
)
$saname = "mynetworkstorageaccount"
$kvname = "mynetworkkeyvault"
$SEP = "Microsoft.Storage", "Microsoft.KeyVault"

#Get VNet Object
$VNet = Get-AzVirtualNetwork -Name $VNetName -ResourceGroupName $VNetRGName

#Add IP address range to the vnet
$VNet.AddressSpace.AddressPrefixes.Add($IPAddressRange)

foreach ($subnet in $subnets) {
    Add-AzVirtualNetworkSubnetConfig -Name $subnet.name -VirtualNetwork $VNet -AddressPrefix $subnet.range -ServiceEndpoint $SEP
}

#Apply configuration stored in $Vnet
Set-AzVirtualNetwork -VirtualNetwork $VNet

$subnet_new = Get-AzVirtualNetwork -ResourceGroupName $VNetRGName -Name $VNetName | Get-AzVirtualNetworkSubnetConfig -Name $snet1
Add-AzStorageAccountNetworkRule -ResourceGroupName $VNetRGName -Name $saname -VirtualNetworkResourceId $subnet_new.Id
Add-AzKeyVaultNetworkRule -ResourceGroupName $VNetRGName -VaultName $kvname -VirtualNetworkResourceId $subnet_new.Id

